<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- jQuery and JS bundle w/ Popper.js -->
    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    
  </head>
  <body onload="loadRooms()">
    <div class="container-fluid">
      <div class="row">
        <div class="col-2">
          Rooms
          <iframe id="rooms" width="100%" height="500px">
      
          </iframe>
        </div>
        <div class="col-10">
          <iframe id="chatbox" width="100%" height="500px">
      
          </iframe>
          <form onSubmit="loadRooms();return false">
            Sample User ID</br>
            Change Current User ID:<input id="uid1" placeholder="Sample User ID" type="number" value="1" ></input>
            <input type="submit"></input>
          </form >
          <form onSubmit="sendText();return false">
            
            
            ReceiverID: <input id="uid2" placeholder="Sample Receiver ID" type="number"></input></br>
        
            RoomID: <label id="room_id" placeholder="Sample Room ID if the two user is connected already" type="number"></label></br>
            message:</br><textarea id="text" placeholder="message" type="text" cols="100"></textarea></br>
            <input type="submit"></input>
          </form>
        </div>
      </div>
      
      
      
      
    </div>

  </body>
  <!-- CSS -->

</html>
<script>

var Socket = new WebSocket("ws://localhost:3414/chatws")

 loadRooms=()=> {
    var result;
    var currentUser = document.getElementById("uid1").value
    $('#rooms').contents().find(`body`).contents().remove("div");
    $('#chatbox').contents().find(`body`).contents().remove();
    $.ajax({
        type: 'GET',
        url: 'http://localhost:3414/api/v1/chats/rooms/'+currentUser,
        success: function(response) {
            result = response.data;
            getMessage=(room_id)=>{
              console.log(room_id)
            }
            result.forEach(room => {
              // $('#rooms').load(()=>{
                $('#rooms').contents().find("body").append(`
                 <div value=${room.room_id} style="border-style:solid" id= ${room.room_id} ><center> ${room.room_id}</center></div>
                `)
              
            });

            $('#rooms').contents().find(`body div`).click(function() {
                    // console.log($('#rooms').contents().find('body div#1'))
                    var chatbox =document.getElementById("chatbox").contentDocument;
                    console.log(this.id)
                    var result;
                    $('#chatbox').contents().find(`body`).contents().remove("div");
                    $('#chatbox').contents().find(`body`).contents().remove("br");
                    // chatbox = "";
                    var currentUser = document.getElementById("uid1").value
                    document.getElementById("room_id").textContent = this.id
                    $.ajax({
                        type: 'GET',
                        url: 'http://localhost:3414/api/v1/chats/room/'+this.id,
                        success: function(response) {
                            result = response.data;
                            getMessage=(room_id)=>{
                              console.log(room_id)
                            }
                            if(result.length>0){
                              result.forEach(room => {
                                if(room.sender_id == currentUser){
                                  chatbox.write(`<div style="text-align:right"> 
                                    <div style="border-radius:5px;padding:15px;background-color:lightblue;display:inline-block">
                                    (${room.created_at}) <b>User ${room.sender_id} </b>: ${room.message} 
                                    </div>
                                    </div></br>`)
                                }
                                else{
                                  chatbox.write(`<div style="text-align:left"> 
                                    <div style="border-radius:5px;padding:15px;background-color:gray;width:fit-content">
                                    (${room.created_at}) <b>User ${room.sender_id} </b>: ${room.message} 
                                    </div>
                                    </div></br>`)
                                }
                                
                                // chatbox.write(`</br>`)
                              });
                            }
                            else{
                              chatbox.write(`<div> No messages </div>`)
                            }
                            
                            
                            console.log(result);
                            document.getElementById("chatbox").contentWindow.scrollTo(0,999999);
                        }
                    });
            });//end of onclick
            console.log(result);
        }//end of first response
    });
}
 sendText=()=> {
  // Construct a msg object containing the data the server needs to process the message from the chat client.
  var msg = {
    type: "message",
    text: document.getElementById("text").value,
    uid1:   document.getElementById("uid1").value,
    uid2:   document.getElementById("uid2").value,
    room_id :document.getElementById("room_id").value,
    date: Date.now()
  };

  // Send the msg object as a JSON-formatted string.
  Socket.send(JSON.stringify(msg));
  
  // Blank the text input element, ready to receive the next line of text from the user.
  document.getElementById("text").value = "";
} 


Socket.onmessage = (event)=> {
  console.log(event.data)

  var msg = JSON.parse(event.data);
  var currentUser = document.getElementById("uid1").value
  var room_id = document.getElementById("uid1").value
  var chatbox = document.getElementById("chatbox").contentDocument;
  var time = new Date(msg.date);
  var timeStr = time.toLocaleTimeString();
  if ( parseInt(currentUser) === parseInt(msg.uid1) || parseInt(currentUser) === parseInt(msg.uid2)){
    chatbox.write(`<div style="text-align:right"> 
    <div style="border-radius:5px;padding:15px;background-color:lightblue;display:inline-block">
    (${timeStr}) <b>User ${currentUser} </b>: ${msg.text} 
    </div>
    </div></br>`)
    // console.log(document.getElementById("chatbox").contentWindow)
    document.getElementById("chatbox").contentWindow.scrollTo(0,999999);

  }
};

</script>
