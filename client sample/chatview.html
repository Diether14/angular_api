<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- jQuery and JS bundle w/ Popper.js -->
    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    
  </head>
  <body onload="loadRooms()">
    <div class="container-fluid">
      <div class="row">
        <div class="col-2">
          Rooms
          <iframe id="rooms" width="100%" height="500px">
      
          </iframe>
          Groups
          <iframe id="groups" width="100%" height="500px">
      
          </iframe>
        </div>
        <div class="col-10">
          <iframe id="chatbox" width="100%" height="500px">
      
          </iframe>
          <form onSubmit="loadRooms();return false">
            Sample User ID</br>
            Change Current User ID:<input id="uid1" placeholder="Sample User ID" type="number" value="2" ></input>
            <input type="submit"></input>
          </form >
          <form onSubmit="sendText();return false">
            
            
            ReceiverID: <input id="uid2" placeholder="Sample Receiver ID" type="number"></input></br>
        
            RoomID: <input id="room_id" placeholder="Sample Room ID if the two user is connected already" type="number"></input></br>
            message:</br><textarea id="text" placeholder="message" type="text" cols="100"></textarea></br>
            <input type="submit"></input>
          </form>

          <!-- <form onSubmit="createGroup();return false"></form> -->
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createGroupModal" onclick="loadUserList()">
              Create Group
            </button>
            <!-- <input type="submit" value="CreateGroup"></input> -->
          <!-- </form> -->
        </div>
      </div>
      
      
      
      
    </div>
<!-- Modal -->
<form onSubmit="createGroup();return false" >
  <div class="modal fade" id="createGroupModal" tabindex="-1" role="dialog" aria-labelledby="createGrouplbl" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createGrouplbl">Create New Group</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Check add to group
          </br>
          GroupName:<input id="groupname"></inpput>
          <div id="userlist">

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>

</form>

</div>
  </body>
  <!-- CSS -->

</html>
<script>

var Socket = new WebSocket("ws://localhost:3414/chatws")
loadUserList=()=>{
    var result;
    $.ajax({
        type: 'GET',
        url: 'http://localhost:3414/api/v1/auth/userlist',
        success: function(response) {
            result = response.data;
            // getMessage=(room_id)=>{
            //   console.log(room_id)
            // }
            if(result.length>0){
              result.forEach(user => {
                $('#userlist').append(`
                    <input id=${user.id_number} value=${user.id_number} type="checkbox"> </input>
                    <label for=${user.id_number}>${user.name}  </label></br>
                `)
              });
            }
            else{

            }
            
            
        }
    });
    
}
loadRooms=()=> {
    var result;
    var currentUser = document.getElementById("uid1").value
    $('#rooms').contents().find(`body`).contents().remove("div");
    $('#chatbox').contents().find(`body`).contents().remove();
    $.ajax({
        type: 'GET',
        url: 'http://localhost:3414/api/v1/chats/rooms/'+currentUser,
        success: function(response) {
            result = response.data;
            getMessage=(room_id)=>{
              console.log(room_id)
            }
            result.forEach(room => {
              // $('#rooms').load(()=>{
                $('#rooms').contents().find("body").append(`
                 <div value=${room.room_id} style="border-style:solid" id= ${room.room_id} ><center> ${room.room_id}</center></div>
                `)
              
            });

            $('#rooms').contents().find(`body div`).click(function() {
                    // console.log($('#rooms').contents().find('body div#1'))
                    var chatbox =document.getElementById("chatbox").contentDocument;
                    console.log(this.id)
                    var result;
                    $('#chatbox').contents().find(`body`).contents().remove("div");
                    $('#chatbox').contents().find(`body`).contents().remove("br");
                    // chatbox = "";
                    var currentUser = document.getElementById("uid1").value
                    document.getElementById("room_id").value = this.id
                    $.ajax({
                        type: 'GET',
                        url: 'http://localhost:3414/api/v1/chats/room/'+this.id,
                        success: function(response) {
                            result = response.data;
                            getMessage=(room_id)=>{
                              console.log(room_id)
                            }
                            if(result.length>0){
                              result.forEach(room => {
                                if(room.sender_id == currentUser){
                                  chatbox.write(`<div style="text-align:right"> 
                                    <div style="border-radius:5px;padding:15px;background-color:lightblue;display:inline-block">
                                    (${room.created_at}) <b>User ${room.sender_id} </b>: ${room.message} 
                                    </div>
                                    </div></br>`)
                                }
                                else{
                                  chatbox.write(`<div style="text-align:left"> 
                                    <div style="border-radius:5px;padding:15px;background-color:gray;width:fit-content">
                                    (${room.created_at}) <b>User ${room.sender_id} </b>: ${room.message} 
                                    </div>
                                    </div></br>`)
                                }
                                
                                // chatbox.write(`</br>`)
                              });
                            }
                            else{
                              chatbox.write(`<div> No messages </div>`)
                            }
                            
                            
                            console.log(result);
                            document.getElementById("chatbox").contentWindow.scrollTo(0,999999);
                        }
                    });
            });//end of onclick
            console.log(result);
        }//end of first response
    });
}
sendText=()=> {
  // Construct a msg object containing the data the server needs to process the message from the chat client.
  var msg = {
    type: "message",
    text: document.getElementById("text").value,
    uid1:   document.getElementById("uid1").value,
    uid2:   document.getElementById("uid2").value,
    room_id :document.getElementById("room_id").value,
    date: Date.now()
  };

  // Send the msg object as a JSON-formatted string.
  Socket.send(JSON.stringify(msg));
  
  // Blank the text input element, ready to receive the next line of text from the user.
  document.getElementById("text").value = "";
} 
createGroup=()=>{
  console.log("submitted")
  // console.log(document.querySelector('#userlist input:checked').value)
  // var userlist = {id:document.querySelector('#userlist input:checked').value}
  var userlist = $('#userlist').find("input:checked")
  var idgroup = []
  userlist.map((test,user)=>{ 
      console.log(user.value)
      // JSON.stringify("id",)
      
      var id={
          id: user.value
      }
      idgroup.push(id)
      // return user
    })
  
  var newgroup =[{
    type: "newgroup",
    group_name:  document.getElementById("groupname").value 
  },idgroup]

  Socket.send(JSON.stringify(newgroup))
  // console.log(JSON.stringify(newgroup))
}
Socket.onmessage = (event)=> {
  console.log(event.data)

  var msg = JSON.parse(event.data);
  var currentUser = document.getElementById("uid1").value
  var room_id = document.getElementById("uid1").value
  var chatbox = document.getElementById("chatbox").contentDocument;
  var time = new Date(msg.date);
  var timeStr = time.toLocaleTimeString();
  if ( parseInt(currentUser) === parseInt(msg.uid1) ){
    chatbox.write(`<div style="text-align:right"> 
    <div style="border-radius:5px;padding:15px;background-color:lightblue;display:inline-block">
    (${timeStr}) <b>User ${currentUser} </b>: ${msg.text} 
    </div>
    </div></br>`)
    // console.log(document.getElementById("chatbox").contentWindow)
    document.getElementById("chatbox").contentWindow.scrollTo(0,999999);
  }
  else{
    chatbox.write(`<div style="text-align:left"> 
    <div style="border-radius:5px;padding:15px;background-color:gray;display:inline-block">
    (${timeStr}) <b>User ${currentUser} </b>: ${msg.text} 
    </div>
    </div></br>`)
    // console.log(document.getElementById("chatbox").contentWindow)
    document.getElementById("chatbox").contentWindow.scrollTo(0,999999);
  }
};
</script>
